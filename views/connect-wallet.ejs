<!DOCTYPE html>
<html>
  <head>
    <title>Connect MetaMask</title>
  </head>
  <body>
    <button id="connect-button">Connect Wallet</button>
    <button id="connect-utu-button" >Connect to UTU</button>

    <div id="status"></div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"
      integrity="sha512-FDcVY+g7vc5CXANbrTSg1K5qLyriCsGDYCE02Li1tXEYdNQPvLPHNE+rT2Mjei8N7fZbe0WLhw27j2SrGRpdMg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
     

      window.addEventListener('load', () => {
        // After window loaded, check for MetaMask and update button
        if (typeof ethereum !== 'undefined') {
          document.getElementById('connect-button').disabled = false;
          document.getElementById('connect-button').innerText =
            'Connect MetaMask';
          document.getElementById('status').innerText = 'MetaMask is installed';
        } else {
          document.getElementById('status').innerText =
            'Please install MetaMask and refresh the page.';
        }
      });

      document
        .getElementById('connect-button')
        .addEventListener('click', async () => {
          // Initialize a provider
          const provider = new ethers.providers.Web3Provider(window.ethereum);

          await provider.send('eth_requestAccounts', []);
          const signer = provider.getSigner();

          // Handle accounts changing
          ethereum.on('accountsChanged', (accounts) => {
            document.getElementById(
              'status'
            ).innerText = `Connected: ${accounts[0]}`;
          });

          // Handle chain (network) changing
          ethereum.on('chainChanged', (chainId) => {
            document.getElementById(
              'status'
            ).innerText = `Chain changed: ${chainId}`;
          });

          try {
            // Sign a message
            const signature = await signer.signMessage('Hello World');
            console.log(signer);

            document.getElementById(
              'status'
            ).innerText = `Signature: ${signature}`;
          } catch (err) {
            document.getElementById(
              'status'
            ).innerText = `Error: ${err.message}`;
          }
        });

		 // Example usage in your connect-wallet.ejs JavaScript code
      async function connectToUTU() {
        try {
          // Check if MetaMask is installed and connected
          if (typeof ethereum !== 'undefined' && ethereum.selectedAddress) {
            const signer = new ethers.Wallet(ethereum.selectedAddress);

            // Call the getAndStoreAccessToken function to authenticate with UTU
            await getAndStoreAccessToken(username, signer);

            // Display a success message or update the UI accordingly
            document.getElementById('status').innerText = 'Connected to UTU';
          } else {
            // Handle the case where MetaMask is not installed or connected
            document.getElementById('status').innerText =
              'Please install and connect MetaMask';
          }
        } catch (error) {
          // Handle errors, display an error message, or log the error
          console.error(error);
          document.getElementById('status').innerText = 'An error occurred';
        }
      }
    </script>
  </body>
</html>
